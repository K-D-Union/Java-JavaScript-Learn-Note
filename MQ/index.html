<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MQ | K-D-Union</title>
    <meta name="description" content="Welcome to K-D-Union&#39;s World">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="icon" href="/Java-JavaScript-Learn-Note/imgs/icon3.svg">
    
    <link rel="preload" href="/Java-JavaScript-Learn-Note/assets/css/0.styles.aeca0e93.css" as="style"><link rel="preload" href="/Java-JavaScript-Learn-Note/assets/js/app.e325ccab.js" as="script"><link rel="preload" href="/Java-JavaScript-Learn-Note/assets/js/2.917e6a38.js" as="script"><link rel="preload" href="/Java-JavaScript-Learn-Note/assets/js/7.2525631d.js" as="script"><link rel="prefetch" href="/Java-JavaScript-Learn-Note/assets/js/10.c7f69dd2.js"><link rel="prefetch" href="/Java-JavaScript-Learn-Note/assets/js/11.809079a5.js"><link rel="prefetch" href="/Java-JavaScript-Learn-Note/assets/js/12.415504f0.js"><link rel="prefetch" href="/Java-JavaScript-Learn-Note/assets/js/13.86adced6.js"><link rel="prefetch" href="/Java-JavaScript-Learn-Note/assets/js/14.0477aa1b.js"><link rel="prefetch" href="/Java-JavaScript-Learn-Note/assets/js/3.5c20f74b.js"><link rel="prefetch" href="/Java-JavaScript-Learn-Note/assets/js/4.c09b0982.js"><link rel="prefetch" href="/Java-JavaScript-Learn-Note/assets/js/5.5fa745d9.js"><link rel="prefetch" href="/Java-JavaScript-Learn-Note/assets/js/6.a2bc2a8b.js"><link rel="prefetch" href="/Java-JavaScript-Learn-Note/assets/js/8.5729813a.js"><link rel="prefetch" href="/Java-JavaScript-Learn-Note/assets/js/9.a9798cc8.js">
    <link rel="stylesheet" href="/Java-JavaScript-Learn-Note/assets/css/0.styles.aeca0e93.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Java-JavaScript-Learn-Note/" class="home-link router-link-active"><!----> <span class="site-name">K-D-Union</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Java-JavaScript-Learn-Note/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/Java-JavaScript-Learn-Note/JavaIndex/" class="nav-link">
  Java基础
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java框架" class="dropdown-title"><span class="title">Java框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/MQ/" class="nav-link router-link-exact-active router-link-active">
  MQ
</a></li><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/Spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/SpringMVC/" class="nav-link">
  SpringMVC
</a></li><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/SpringCloud/" class="nav-link">
  SpringCloud
</a></li></ul></div></div><div class="nav-item"><a href="/Java-JavaScript-Learn-Note/JavaSoundCode/" class="nav-link">
  Java源码
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端框架" class="dropdown-title"><span class="title">前端框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/TypeScript/" class="nav-link">
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/React/" class="nav-link">
  React
</a></li></ul></div></div> <a href="https://github.com/K-D-Union/Java-JavaScript-Learn-Note.git" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Java-JavaScript-Learn-Note/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/Java-JavaScript-Learn-Note/JavaIndex/" class="nav-link">
  Java基础
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java框架" class="dropdown-title"><span class="title">Java框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/MQ/" class="nav-link router-link-exact-active router-link-active">
  MQ
</a></li><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/Spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/SpringMVC/" class="nav-link">
  SpringMVC
</a></li><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/SpringCloud/" class="nav-link">
  SpringCloud
</a></li></ul></div></div><div class="nav-item"><a href="/Java-JavaScript-Learn-Note/JavaSoundCode/" class="nav-link">
  Java源码
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端框架" class="dropdown-title"><span class="title">前端框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/TypeScript/" class="nav-link">
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/Java-JavaScript-Learn-Note/React/" class="nav-link">
  React
</a></li></ul></div></div> <a href="https://github.com/K-D-Union/Java-JavaScript-Learn-Note.git" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>MQ</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Java-JavaScript-Learn-Note/MQ/#消息队列" class="sidebar-link">消息队列</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Java-JavaScript-Learn-Note/MQ/#消息队列的组成" class="sidebar-link">消息队列的组成</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Java-JavaScript-Learn-Note/MQ/#broker" class="sidebar-link">Broker</a></li><li class="sidebar-sub-header"><a href="/Java-JavaScript-Learn-Note/MQ/#producer" class="sidebar-link">Producer</a></li><li class="sidebar-sub-header"><a href="/Java-JavaScript-Learn-Note/MQ/#consumer" class="sidebar-link">Consumer</a></li><li class="sidebar-sub-header"><a href="/Java-JavaScript-Learn-Note/MQ/#topic" class="sidebar-link">Topic</a></li><li class="sidebar-sub-header"><a href="/Java-JavaScript-Learn-Note/MQ/#queue" class="sidebar-link">Queue</a></li><li class="sidebar-sub-header"><a href="/Java-JavaScript-Learn-Note/MQ/#message" class="sidebar-link">Message</a></li></ul></li><li><a href="/Java-JavaScript-Learn-Note/MQ/#应用解耦" class="sidebar-link">应用解耦</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Java-JavaScript-Learn-Note/MQ/#流量削峰" class="sidebar-link">流量削峰</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Java-JavaScript-Learn-Note/MQ/#mq保证消息的不丢失" class="sidebar-link">MQ保证消息的不丢失</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Java-JavaScript-Learn-Note/MQ/#rabbitmq" class="sidebar-link">RabbitMQ</a></li><li class="sidebar-sub-header"><a href="/Java-JavaScript-Learn-Note/MQ/#kafka" class="sidebar-link">kafka</a></li></ul></li><li><a href="/Java-JavaScript-Learn-Note/MQ/#mq之间的对比" class="sidebar-link">MQ之间的对比</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1>MQ整合</h1> <h2 id="消息队列"><a href="#消息队列" class="header-anchor">#</a> 消息队列</h2> <p>        消息队列也被称之为MQ，消息队列并不是什么高端的技术，只是微服务架构中的，解决应用的解耦、异步消息、流量削峰、消息分发的一个中间件；什么是消息队列呢？消息应该都理解是什么，队列呢，队列是大家在银行办理业务时人多了需要排队是一个概念，这也就不难理解消息队列了（可以理解成在排队的消息，并且里面有多个窗口）。
<img src="/Java-JavaScript-Learn-Note/imgs/clipboard.png" alt="clipboard"></p> <h2 id="消息队列的组成"><a href="#消息队列的组成" class="header-anchor">#</a> 消息队列的组成</h2> <h3 id="broker"><a href="#broker" class="header-anchor">#</a> Broker</h3> <p>        消息服务器，作为server提供消息核心服务</p> <h3 id="producer"><a href="#producer" class="header-anchor">#</a> Producer</h3> <p>        消息生产者，业务的发起方，负责生产消息传输给broker，</p> <h3 id="consumer"><a href="#consumer" class="header-anchor">#</a> Consumer</h3> <p>        消息消费者，业务的处理方，负责从broker获取消息并进行业务逻辑处理</p> <h3 id="topic"><a href="#topic" class="header-anchor">#</a> Topic</h3> <p>        主题，发布订阅模式下的消息统一汇集地，不同生产者向topic发送消息，由MQ服务器分发到不同的订阅者，实现消息的       广播</p> <h3 id="queue"><a href="#queue" class="header-anchor">#</a> Queue</h3> <p>        队列，PTP模式下，特定生产者向特定queue发送消息，消费者订阅特定的queue完成指定消息的接收</p> <h3 id="message"><a href="#message" class="header-anchor">#</a> Message</h3> <p>        消息体，根据不同通信协议定义的固定格式进行编码的数据包，来封装业务数据，实现消息的传输</p> <h2 id="应用解耦"><a href="#应用解耦" class="header-anchor">#</a> 应用解耦</h2> <p>        以微服务中的订单系统，支付系统、库存系统为例，三个代表每个系统模块的微服务，当
用户下完订单后，需要告诉支付系统有用户已下单--&gt;需要付款、需要减少库存等操作；如果耦合调用的话，当其中任何一个环节出现了问题，可能需要几分钟才能修复，都会订单失败，会导致服务在这段未修复的时间段中，服务不能用，可能会导致一部分用户的丢失或投诉等相关问题；如果使用消息队列降解耦后，订单系统只需要把下的订单发送到消息队列中，当其中某个环节在此出现上述的问题时，只需要先把消息存放在消息队列中，等系统修复完成之后，重新监听系统中的消息对消息进行消费操作即可。</p> <img src="/Java-JavaScript-Learn-Note/imgs/duilie.png" alt="应用解耦"> <h2 id="流量削峰"><a href="#流量削峰" class="header-anchor">#</a> 流量削峰</h2> <p>        微服务中常见的订单系统为例，假如订单系统每秒钟只能处理10W条订单量，在正常的情况下是没有问题的，突然有一天每秒来了20W的订单需要处理，但是这时已经超出系统能承受的范围了，一般有时候会把订单限制在10W条之内，超出10W的直接做阻断的操作；这种虽然也可以解决，但是对用户可能就不是很友好了。消息队列中的流量削峰的概念可以解决以上出现的问题，用消息队列作为缓冲，当用户操作的时候先把用户的订单信息存放在消息队列中，当流量到达处理的顶峰的时候，可以使用消息堆积的方式，只处理到达顶峰之前的订单，另一部分等处理完成之后再进行处理。</p> <h2 id="mq保证消息的不丢失"><a href="#mq保证消息的不丢失" class="header-anchor">#</a> MQ保证消息的不丢失</h2> <h3 id="rabbitmq"><a href="#rabbitmq" class="header-anchor">#</a> RabbitMQ</h3> <p>        1、选择MQ提供的事物功能，生产者在发布消息之前开启一个事物，然后进行消息的发送，mq接受到消息后，会自动提交事物，如果mq没有收到成功的消息，会异常报错，进行错误捕获，消息重新发送。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>缺点：效率低下、因为开启了mq的事物，会变成阻塞状态，等待处理结果结束后返回，再进行下一步的处理。</p></div> <div class="language-java extra-class"><pre class="language-java"><code>channel<span class="token punctuation">.</span><span class="token function">txSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开启事物</span>
  <span class="token keyword">try</span><span class="token punctuation">{</span>
      <span class="token comment">//发送消息</span>
  <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exection</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
      channel<span class="token punctuation">.</span><span class="token function">txRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>；<span class="token comment">//回滚事物</span>
      <span class="token comment">//重新提交</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>        2、在生产者哪里设置开启了confirm模式之后，每次写的消息都会分配一个唯一的id，然后如何写入了rabbitmq之中，rabbitmq会给你回传一个ack消息，告诉你这个消息发送OK了；如果rabbitmq没能处理这个消息，会回调你一个nack接口，告诉你这个消息失败了，你可以进行重试。而且你可以结合这个机制知道自己在内存里维护每个消息的id，如果超过一定时间还没接收到这个消息的回调，那么你可以进行重发。</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token comment">//开启confirm</span>
    channel<span class="token punctuation">.</span><span class="token function">confirm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//发送成功回调</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ack</span><span class="token punctuation">(</span><span class="token class-name">String</span> messageId<span class="token punctuation">)</span><span class="token punctuation">{</span>
      
    <span class="token punctuation">}</span>
    <span class="token comment">// 发送失败回调</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nack</span><span class="token punctuation">(</span><span class="token class-name">String</span> messageId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//重发该消息</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="消费者弄丢数据解决方案"><a href="#消费者弄丢数据解决方案" class="header-anchor">#</a> 消费者弄丢数据解决方案</h4> <p>        使用rabbitmq提供的ack机制，首先关闭rabbitmq的自动ack，然后每次在确保处理完这个消息之后，在代码里手动调用ack。这样就可以避免消息还没有处理完就ack。</p> <h3 id="kafka"><a href="#kafka" class="header-anchor">#</a> kafka</h3> <h4 id="消费端丢失"><a href="#消费端丢失" class="header-anchor">#</a> 消费端丢失</h4> <p>        1、消费端消息丢失是通过，关闭自定提交offset，在自己处理完毕之后手动提交offset，这样就可以保证消费端的不会把消息弄丢</p> <h4 id="自身消息丢失"><a href="#自身消息丢失" class="header-anchor">#</a> 自身消息丢失</h4> <p>        1、kafka自身消息丢失问题，可以同过设置参数来保证消息的不丢失：
① 给topic设置 replication.factor参数：这个值必须大于1，表示每个partition必须至少有两个副本；
②在kafka服务端设置min.isync.replicas参数：这个值必须大于1，表示 要求一个leader至少感知到有至少一个follower在跟自己保持联系正常同步数据，这样才能保证leader挂了之后还有一个follower。
③在生产者端设置acks=all：表示 要求每条每条数据，必须是写入所有replica副本之后，才能认为是写入成功了
④在生产者端设置retries=MAX(很大的一个值，表示无限重试)：表示 这个是要求一旦写入事变，就无限重试。</p> <h4 id="生产消息丢失"><a href="#生产消息丢失" class="header-anchor">#</a> 生产消息丢失</h4> <p>        如果按照上面设置了ack=all，则一定不会丢失数据，要求是，你的leader接收到消息，所有的follower都同步到了消息之后，才认为本次写成功了。如果没满足这个条件，生产者会自动不断的重试，重试无限次。</p> <h2 id="mq之间的对比"><a href="#mq之间的对比" class="header-anchor">#</a> MQ之间的对比</h2> <table><thead><tr><th>特性</th> <th style="text-align:center;">ActiveMQ</th> <th style="text-align:center;">RabbitMQ</th> <th style="text-align:center;">RocketMQ</th> <th style="text-align:center;">Kafka</th></tr></thead> <tbody><tr><td>API完备性</td> <td style="text-align:center;">高</td> <td style="text-align:center;">高</td> <td style="text-align:center;">高</td> <td style="text-align:center;">高</td></tr> <tr><td>多语言支持</td> <td style="text-align:center;">支持,Java优先</td> <td style="text-align:center;">语言无关</td> <td style="text-align:center;">只支持Java</td> <td style="text-align:center;">支持,Java优先</td></tr> <tr><td>单机吞吐量</td> <td style="text-align:center;">万级</td> <td style="text-align:center;">万级</td> <td style="text-align:center;">万级</td> <td style="text-align:center;">十万级</td></tr> <tr><td>消息延迟</td> <td style="text-align:center;"></td> <td style="text-align:center;">微秒级</td> <td style="text-align:center;">毫秒级</td> <td style="text-align:center;">毫秒级</td></tr> <tr><td>可用性</td> <td style="text-align:center;">高</td> <td style="text-align:center;">（主从）</td> <td style="text-align:center;">高（主从）</td> <td style="text-align:center;">非常高（分布式）</td></tr> <tr><td>消息丢失</td> <td style="text-align:center;">低</td> <td style="text-align:center;">低</td> <td style="text-align:center;">理论上不会丢失</td> <td style="text-align:center;">理论上不会丢失</td></tr></tbody></table></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新时间:</span> <span class="time">8/24/2020, 11:25:59 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/Java-JavaScript-Learn-Note/assets/js/app.e325ccab.js" defer></script><script src="/Java-JavaScript-Learn-Note/assets/js/2.917e6a38.js" defer></script><script src="/Java-JavaScript-Learn-Note/assets/js/7.2525631d.js" defer></script>
  </body>
</html>
